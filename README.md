# stable-diffusion-gpu-docker

`stable-diffusion-gpu-docker` is the Docker Image for using Stable Diffusion on air-gapped computers.

**Notice**

- Loading weights from [[openai/clip-vit-large-patch14]](https://huggingface.co/openai/clip-vit-large-patch14) as a pretrained model for `CLIPFeatureExtractor`.
- Loading weights from [[CompVis/stable-diffusion-v-1-4-original]](https://huggingface.co/CompVis/stable-diffusion-v-1-4-original) and saving it as `model.ckpt`.


### Get started

```bash
$ chmox +x ./setup.sh
$ ./setup.sh

$ docker run \
  --gpus all \
  -it \
  --rm \
  -v ${PWD}/shared:/app/stable-diffusion/shared stable-diffusion-gpu-docker \
  /bin/bash

$ python scripts/txt2img.py \
  --prompt "a photograph of an astronaut riding a horse" \
  --plms \
  --n_samples 1 \
  --skip_grid \
  --outdir shared/outputs/txt2img-samples
```

`./shared/` directory is mounted by the Docker container, you can put an image in it and also draw an image from.

```bash
shared/ # mounted by docker container
  inputs/    # to store input files
  outputs/
    img2img-samples/  # to store samples of images generated by the img2img model
    txt2img-samples/  # to store samples of images generated by the txt2img model
```

### Run



```bash
$ docker run --gpus all -it --rm -v ${PWD}/shared:/app/stable-diffusion/shared stable-diffusion-gpu-docker /bin/bash
---
# text-to-image
$ python scripts/txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms --n_samples 1 --skip_grid --outdir shared/outputs/txt2img-samples

# image-to-image
$ python scripts/img2img.py --prompt "A fantasy landscape, trending on artstation" --init-img shared/inputs/sketch-mountains-input.jpg --strength 0.8 --outdir shared/outputs/img2img-samples
```

### Build

```bash
$ docker build -t stable-diffusion-gpu-docker .
```

<!-- ### Distribute

```bash
$ docker pull docker/dockerfile:1
$ docker pull pytorch/pytorch:1.12.1-cuda11.3-cudnn8-runtime

$ docker save docker/dockerfile:1 -o dockerimages/img_dockerfile-1.tar
$ docker save pytorch/pytorch:1.12.1-cuda11.3-cudnn8-runtime -o dockerimages/img_pytorch-cuda-runtime.tar
$ docker save stable-diffusion-gpu-docker -o dockerimages/img_stable-diffusion-gpu-docker.tar
``` -->